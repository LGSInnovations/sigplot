<!DOCTYPE html>
<html>

<head>
    
        <title>SigPlot Examples: Streaming</title>
<meta charset="utf-8">
            <link href="../bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../prism/prism.css" rel="stylesheet" type="text/css">
<style type="text/css">
#banner {
	font: 18px/1.5em "proxima-nova", Helvetica, Arial, sans-serif;
	text-align: center;
	width: 100%;
}

#subbanner {
	font: 18px/1.5em "proxima-nova", Helvetica, Arial, sans-serif;
	text-align: center;
	width: 100%;
}

#logos {
	width: 600px;
}

.navbar-logo {
	padding-top: 5px;
	padding-bottom: 5px;
}

a img {
	border: 0;
}

.jumbotron {
	-webkit-box-shadow: rgba(255, 255, 255, 0.1) 0 1px 0, rgba(0, 0, 0, 0.8)
		0 1px 7px 0px inset;
	-moz-box-shadow: rgba(255, 255, 255, 0.1) 0 1px 0, rgba(0, 0, 0, 0.8) 0
		1px 7px 0px inset;
	box-shadow: rgba(255, 255, 255, 0.1) 0 1px 0, rgba(0, 0, 0, 0.8) 0 1px
		7px 0px inset;
	background: #202020;
	background-color: rgba(0, 0, 0, 0.3);
	border: 0;
	filter: progid:DXImageTransform.Microsoft.gradient(startColorstr=#88000000,
		endColorstr=#88000000);
	padding-top: 20px;
}

#footer {
	text-align: center;
}

#sourceModal .modal-body
{
   max-height:80%;
}
#sourceModal .modal-dialog
{
   height:80%;
   max-height:80%;
   width:70%;
}

#plot {
	height: 400px;
	width: 90%;
	box-shadow: 5px 5px 5px #888888;
	border-style: solid;
	border-width: 1px;
	padding-left: 0;
	padding-right: 0;
	margin-left: auto;
	margin-right: auto;
	margin-top: 10px;
	display: block;
}

#left-plot {
	height: 400px;
	width: 48%;
	box-shadow: 5px 5px 5px #888888;
	border-style: solid;
	border-width: 1px;
	padding-left: 0;
	padding-right: 0;
	margin-top: 10px;
	float: left;
}

#right-plot {
	height: 400px;
	width: 48%;
	box-shadow: 5px 5px 5px #888888;
	border-style: solid;
	border-width: 1px;
	padding-left: 0;
	padding-right: 0;
	margin-top: 10px;
	float: right;
}

#top-plot {
	height: 400px;
	width: 90%;
	box-shadow: 5px 5px 5px #888888;
	border-style: solid;
	border-width: 1px;
	padding-left: 0;
	padding-right: 0;
	margin-left: auto;
	margin-right: auto;
}

#bottom-plot {
	height: 400px;
	width: 90%;
	box-shadow: 5px 5px 5px #888888;
	border-style: solid;
	border-width: 1px;
	padding-left: 0;
	padding-right: 0;
	margin-left: auto;
	margin-right: auto;
}
</style>

                <link href="../opentip/opentip.css" rel="stylesheet" type="text/css">
</head>

<body>
    <div class="container">
        <!-- Modal -->
<div class="modal" id="sourceModal" tabindex="-1" role="dialog" aria-labelledby="sourceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Streaming Example Source Code</h4>
      </div>
      <div class="modal-body">
        <pre class="line-numbers" style="overflow:scroll; max-height: 600px">
        	<code id="source-code-example" class="language-javascript">
        	</code>
        </pre>
        <p>
        <a href="javascript:void(0)" onclick='window.location="view-source:" + window.location.href'>View Raw Source</a>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="header">
	<div class="collapse navbar-collapse menu-above pull-right">
		<div class="menu-header-container">
			<ul id="menu-standard-top-navigation" class="nav navbar-nav menu">
			    <li><a id="view-source" href="#sourceModal" data-toggle="modal">View Source</a></li>
				<li class="dropdown menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children">
					<a href="examples" class="dropdown-toggle" data-toggle="dropdown" title="Developer Examples">Developer Examples<b class="caret"></b></a>
					<ul class="dropdown-menu">
						<li class="menu-item menu-item-type-custom"><a href="basic_usage.html">Basic Usage</a></li>
						<li class="menu-item menu-item-type-custom"><a href="realtime.html">Streaming (i.e. Realtime) Plotting</a></li>
						<li class="menu-item menu-item-type-custom"><a href="audio.html">Plotting AudioBuffers</a></li>
						<li class="menu-item menu-item-type-custom"><a href="menu.html">Menu</a></li>
						<li class="menu-item menu-item-type-custom"><a href="mtag.html">Mouse Events (i.e. MTAGs)</a></li>
						<li class="menu-item menu-item-type-custom"><a href="selection.html">Mouse Selection</a></li>
						<li class="menu-item menu-item-type-custom"><a href="appearance.html">Appearance</a></li>
						<li class="menu-item menu-item-type-custom"><a href="plugins.html">Plugins</a></li>
					</ul>
				</li>
			</ul>
		</div>
	</div> <!-- /.nav-collapse -->
	<a href="../index.html"> <span><img class="navbar-logo" alt='' src='../images/sigplot_2color_outline_sm.png' alt="SigPlot" />&nbsp;</span></a>
</div> <!-- /header -->

            <div class="jumbotron">
                <div class="controls">
                    <div class="input-group input-group-sm">
                        <span class="input-group-addon">fps</span>
                        <input id="framerate" min="1" max="100" value="10" type="range" class="input-medium form-control">
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-addon">freq1</span>
                        <input id="freq1" min="100" max="22000" value="10" type="range" class="input-medium form-control">
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-addon">freq2</span>
                        <input id="freq2" min="100" max="22000" value="10" type="range" class="input-medium form-control">
                    </div>
                    <div class="btn-group">
                        <button type="button-primary" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                            Raster Mode <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a id="scrolling" href="#">Scrolling</a>
                            </li>
                            <li><a id="rising" href="#">Rising</a>
                            </li>
                            <li><a id="falling" href="#">Falling</a>
                            </li>
                        </ul>
                    </div>
                    <div class="btn-group">
                        <button type="button-primary" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                            Raster Color Map <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a id="defaultcmap" href="#">Default</a>
                            </li>
                            <li><a id="greyscale" href="#">Greyscale</a>
                            </li>
                            <li><a id="ramp" href="#">Ramp</a>
                            </li>
                            <li><a id="wheel" href="#">Wheel</a>
                            </li>
                            <li><a id="spectrum" href="#">Spectrum</a>
                            </li>
                            <li><a id="sunset" href="#">Sunset</a>
                            </li>
                        </ul>
                    </div>
                    <span id="freq1val" class="label label-default">0 Hz</span>
                    <span id="freq2val" class="label label-default">0 Hz</span>
                </div>
                <!-- /controls -->
                <div id="top-plot"></div>
                <div id="bottom-plot"></div>
                <div style="clear: both"></div>
            </div>
            <!-- /jumbotron -->
            <div id="content">
                <h2>Streaming/Real-time Plotting</h2>
                <p>For Layer1D, you can stream data to the plot by using the reload method.</p>
                <pre>
				<code class="language-javascript">
plot_layer = plot.overlay_array(null, {
	xdelta : xdelta,
	xunits : 3,
	yunits : 26,
	size : fftsize / 2
});

// When new data comes in.
var data = [...];
plot.reload(plot_layer, data);
				</code>
			</pre>
                <p>
                    Currently the data <b>must</b> be a Javascript array. The plot will automatically be scaled to the new data based on the 'autox' and 'autoy' options. However, when plotting a stream of data you may want to have the scaling adjust more
                    smoothly. This can be done with the 'autol' option which specifies how many frames are averaged together when rescaling.
                </p>
                <p>Often when using a plot to display streaming data you will also adjust the appearance (i.e. autohide panbars, etc.).</p>
                <pre>
				<code class="language-javascript">
plot = new sigplot.Plot(document.getElementById('plot'), {all: true, expand: true, autol: 100, autohide_panbars: true});
				</code>
			</pre>
                <p>
                    For Layer2D, use the overlay_pipe() method and push()
                </p>
                <pre>
				<code class="language-javascript">
raster_layer = raster.overlay_pipe({
	type : 2000,
	subsize : fftsize / 2,
	xdelta : xdelta,
	xunits : 3
});

// When new data comes in.
var data = [...];
plot.push(data_layer, data);
				</code>
			</pre>
            </div>
    </div>

    <!-- /container -->
    <div class="well">
    <div id="footer" class="footer">
      <p>
        <a style="border: none" href="http://www.lgsinnovations.com"><img src="../images/lgs-innovation.jpg"/></a><br/>
      </p>
      <p>
        <small><img src="../images/creativecommons.png" alt="" /> All
                documentation is under the Creative Commons Attribution Share-alike
                license.<br /></small>
      </p>
      <p>
        <small>&copy; 2012-2017 LGS Innovations, Inc.</small><br />
      </p>

    </div>
</div>

        <script src="../jquery/jquery.min.js" type="text/javascript"></script>
<script src="../bootstrap/bootstrap.min.js" type="text/javascript"></script>
<script src="../prism/prism.js"></script>
<script src="../dsp.js"></script>
<script src="../sigplot/sigplot-minimized.js"></script>
<script>
$(window).ready(function() {
	var example_src_script = $("#example-source");
	if ( example_src_script.length ) {
		$("#source-code-example").text(example_src_script.text());
    } else {
    	$("#view-source").hide();
    }
});
</script>

            <script src="../opentip/opentip.js"></script>
            <script src="../opentip/adapter-jquery.js"></script>
            <script src="../sigplot/sigplot.plugins-minimized.js"></script>
            <script id="example-source">
                function getURLParameter(name) {
                    return decodeURI((RegExp(name + '=' + '(.+?)(&|$)').exec(
                        location.search) || [, null])[1]);
                }

                var plot;
                var raster;
                var annotaions;
                var updater;

                var plot_layer;
                var raster_layer;

                var fs = 44100;
                var fftsize = 2048;
                var xdelta = fs / fftsize;

                var complex_mode = (getURLParameter("complex") === "true");
                console.log('complex mode:', complex_mode)

                var osc1 = new Oscillator(DSP.SINEWAVE, 440, 1, 2048, 44100);
                var hann1 = new WindowFunction(DSP.HANN)
                var fft1 = new FFT(fftsize, fs);

                var osc2 = new Oscillator(DSP.SINEWAVE, 14400, 1, 2048, 44100);
                var hann2 = new WindowFunction(DSP.HANN)
                var fft2 = new FFT(fftsize, fs);

                function initialize() {
                    try {
                        plot = new sigplot.Plot(document.getElementById('top-plot'), {
                            autol: 5,
                            cmode: "LO",
                            // Use click to tune xcnt : "continuous",
                            autohide_panbars: true
                        });

                        raster = new sigplot.Plot(document.getElementById('bottom-plot'), {
                            autol: 5,
                            cmode: "LO",
                            autohide_panbars: true
                        });

                    } catch (error) {
                        plot = undefined;
                        errorMessage = document.createElement("span");
                        errorMessage.innerHTML = "Your browser is not compatible with Web SigPlot...Sorry";
                        errorMessage.style.display = "block";
                        errorMessage.style.color = "black";
                        errorMessage.style.top = "50%";
                        errorMessage.style.width = "100%";
                        errorMessage.style.fontSize = "150%";
                        errorMessage.style.textAlign = "center";
                        document.getElementById('top-plot').appendChild(errorMessage);
                        console.log(error);
                        return;
                    }

                    annotations = new sigplot.AnnotationPlugin();
                    raster.add_plugin(annotations);

                    if (complex_mode) {
                        plot_layer1 = plot.overlay_array(null, {
                            format: 'CF',
                            xdelta: xdelta,
                            xunits: 3,
                            size: fftsize / 2,
                            yunits: 26
                        });

                        plot_layer2 = plot.overlay_array(null, {
                            format: 'CF',
                            xdelta: xdelta,
                            xunits: 3,
                            size: fftsize / 2,
                            yunits: 26
                        });

                        raster_layer = raster.overlay_pipe({
                            type: 2000,
                            format: 'CF',
                            subsize: fftsize / 2,
                            xdelta: xdelta,
                            pipesize: (fftsize / 2) * 8,
                            xunits: 3
                        });
                    } else {
                        plot_layer1 = plot.overlay_array(null, {
                            xdelta: xdelta,
                            xunits: 3,
                            yunits: 26,
                            size: fftsize / 2
                        });

                        plot_layer2 = plot.overlay_array(null, {
                            xdelta: xdelta,
                            xunits: 3,
                            yunits: 26,
                            size: fftsize / 2
                        });

                        raster_layer = raster.overlay_pipe({
                            type: 2000,
                            subsize: fftsize / 2,
                            xdelta: xdelta,
                            xunits: 3
                        });
                    }

                    $("#freq").html(osc1.frequency.toFixed(2) + " Hz");
                    raster.mimic(plot, {
                        xzoom: true,
                        unzoom: true,
                        xpan: true
                    });
                    plot.mimic(raster, {
                        xzoom: true,
                        unzoom: true,
                        xpan: true
                    });
                }

                function update() {
                    osc1.generate();
                    hann1.process(osc1.signal)
                    fft1.forward(osc1.signal);
                    var spectrum1;
                    if (complex_mode) {
                        spectrum1 = DSP.interleave(fft1.real, fft1.imag);
                        spectrum1 = spectrum1.subarray(0, fftsize);
                    } else {
                        spectrum1 = fft1.spectrum;
                    }

                    // Reload the data layer
                    if (plot_layer1 !== undefined) {
                        plot.reload(plot_layer1, spectrum1);
                    }

                    osc2.generate();
                    hann2.process(osc2.signal)
                    fft2.forward(osc2.signal);
                    var spectrum2;
                    if (complex_mode) {
                        spectrum2 = DSP.interleave(fft2.real, fft2.imag);
                        spectrum2 = spectrum2.subarray(0, fftsize);
                    } else {
                        spectrum2 = fft2.spectrum;
                    }
                    if (plot_layer2 !== undefined) {
                        plot.reload(plot_layer2, spectrum2);
                    }

                    var mix = DSP.mixSampleBuffers(spectrum1, spectrum2, false, 1);
                    if (raster_layer !== undefined) {
                        raster.push(raster_layer, mix);
                    }
                }

                $(window).ready(function() {
                    initialize();

                    $("#framerate").value = 10;
                    $("#framerate").on('input', function() {
                        change_framerate();
                    });
                    change_framerate();

                    $("#freq1").val(osc1.frequency.toFixed(2));
                    $("#freq1").on('input', function() {
                        change_freq1();
                    });
                    change_freq1();

                    $("#freq2").val(osc2.frequency.toFixed(2));
                    $("#freq2").on('input', function() {
                        change_freq2();
                    });
                    change_freq2();

                    $('#scrolling').on('click', function(e) {
                        raster.change_settings({
                            drawmode: 'scrolling'
                        });
                        annotations.clear_annotations();
                    });
                    $('#rising').on('click', function(e) {
                        raster.change_settings({
                            drawmode: 'rising'
                        });
                        annotations.clear_annotations();
                    });
                    $('#falling').on('click', function(e) {
                        raster.change_settings({
                            drawmode: 'falling'
                        });
                        annotations.clear_annotations();
                    });

                    $('#defaultcmap').on('click', function(e) {
                        console.log("DEFAULT!")
                        raster.change_settings({
                            cmap: null
                        });
                    });
                    $('#greyscale').on('click', function(e) {
                        raster.change_settings({
                            cmap: 0
                        });
                    });
                    $('#ramp').on('click', function(e) {
                        raster.change_settings({
                            cmap: 1
                        });
                    });
                    $('#wheel').on('click', function(e) {
                        raster.change_settings({
                            cmap: 2
                        });
                    });
                    $('#spectrum').on('click', function(e) {
                        raster.change_settings({
                            cmap: 3
                        });
                    });
                    $('#sunset').on('click', function(e) {
                        raster.change_settings({
                            cmap: 4
                        });
                    });

                    plot.addListener("mtag", function(event) {
                        // values directly on the at the axis edges
                        // will cause the osciallator problems...on the
                        // upper edge you need to to stay one whole
                        // frequency bin away from the axis
                        if ((event.x > 0) && (event.x < 22028)) {
                            if (event.x != osc1.frequency) {
                                osc1.setFreq(event.x);
                                $("#freq1").val(osc1.frequency.toFixed(2));
                                $("#freq1val").html(osc1.frequency.toFixed(2) + " Hz");
                            }
                        }
                    });

                    raster.addListener("mtag", function(event) {
                        annotations.add_annotation({
                            x: event.x,
                            y: event.y,
                            value: "click"
                        });
                    });

                    raster.addListener("annotationhighlight", function(evt) {
                        if (evt.state) {
                            if (!evt.annotation.tooltip) {
                                var msg = "x=" + evt.annotation.x + " y=" + evt.annotation.y;
                                evt.annotation.tooltip = new Opentip($('#bottom-plot'),
                                    msg, {
                                        "extends": "glass",
                                        showOn: null
                                    });
                            }
                            evt.annotation.tooltip.show();
                        } else {
                            if (evt.annotation.tooltip) {
                                evt.annotation.tooltip.hide();
                            }
                        }
                    });

                });

                function change_framerate() {
                    var framerate = document.getElementById('framerate').value;

                    framerate = parseFloat(framerate);
                    if (isNaN(framerate)) {
                        alert("Invalid framerate");
                        return;
                    }
                    if (framerate <= 0) {
                        alert("Invalid framerate");
                        return;
                    }

                    var interval = (1.0 / framerate) * 1000;
                    if (updater !== undefined) {
                        window.clearInterval(updater);
                    }
                    updater = window.setInterval(update, interval);
                }

                function change_freq1() {
                    var freq1 = document.getElementById('freq1').value;

                    freq1 = parseFloat(freq1);
                    if (isNaN(freq1)) {
                        alert("Invalid freq1");
                        return;
                    }
                    if (freq1 <= 0) {
                        alert("Invalid freq1");
                        return;
                    }

                    osc1.setFreq(freq1);
                    $("#freq1val").html(osc1.frequency.toFixed(2) + " Hz");
                }

                function change_freq2() {
                    var freq2 = document.getElementById('freq2').value;

                    freq2 = parseFloat(freq2);
                    if (isNaN(freq2)) {
                        alert("Invalid freq2");
                        return;
                    }
                    if (freq2 <= 0) {
                        alert("Invalid freq2");
                        return;
                    }

                    osc2.setFreq(freq2);
                    $("#freq2val").html(osc2.frequency.toFixed(2) + " Hz");
                }
            </script>
</body>

</html>
